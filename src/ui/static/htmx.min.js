(function(){
  async function request(url){
    const res = await fetch(url);
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    return res.json();
  }
  function render(rows){
    const tbody = document.querySelector('#results');
    if(!tbody){ return; }
    if(rows.length === 0){
      tbody.innerHTML = '<tr><td colspan="8">No results.</td></tr>';
      return;
    }
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.drug_id}</td>
        <td>${r.event_id}</td>
        <td>${r.year_quarter}</td>
        <td>${r.recent_ror.toFixed(2)}</td>
        <td>${r.ci_low.toFixed(2)} â€“ ${r.ci_high.toFixed(2)}</td>
        <td>${r.lit_support}</td>
        <td>${r.trend_z.toFixed(2)}</td>
        <td>${r.score.toFixed(2)}</td>
      </tr>
    `).join('');
  }
  async function loadInitial(){
    try{
      const rows = await request('/signals');
      render(rows);
    }catch(err){
      console.error(err);
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#search');
    form?.addEventListener('submit', async (event) => {
      event.preventDefault();
      const data = new FormData(form);
      const drug = data.get('drug');
      const url = drug ? `/signals?drug=${encodeURIComponent(drug)}` : '/signals';
      try {
        const rows = await request(url);
        render(rows);
      } catch (err) {
        console.error(err);
      }
    });
    loadInitial();
  });
})();
